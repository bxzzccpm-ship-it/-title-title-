// === (1) التعريف التقليدي الآمن الذي يعمل على جهازك ===
// هذا الكود يتجاوز مشكلة "No createScene export"
var canvas = document.getElementById("renderCanvas");
var engine = new BABYLON.Engine(canvas, true);

var createScene = function () {
    var scene = new BABYLON.Scene(engine);
    scene.clearColor = new BABYLON.Color3(0.6, 0.8, 1.0); 

    // ==================================================
    // 1. فيزياء
    var gravityVector = new BABYLON.Vector3(0, -9.81, 0);
    var physicsPlugin = new BABYLON.CannonJSPlugin(); 
    scene.enablePhysics(gravityVector, physicsPlugin);

    // 2. ضوء وظل
    var light = new BABYLON.DirectionalLight("dirLight", new BABYLON.Vector3(-0.5, -1, -0.5), scene);
    light.position = new BABYLON.Vector3(20, 40, 20);
    light.intensity = 1.0;
    var hemi = new BABYLON.HemisphericLight("hemi", new BABYLON.Vector3(0,1,0), scene);
    hemi.intensity = 0.3;
    var shadowGen = new BABYLON.ShadowGenerator(1024, light);
    shadowGen.useBlurExponentialShadowMap = true;
    shadowGen.blurKernel = 8;

    // 3. الأرضية
    var ground = BABYLON.MeshBuilder.CreateGround("ground", {width:120, height:120}, scene);
    var groundMat = new BABYLON.StandardMaterial("groundMat", scene);
    groundMat.diffuseColor = new BABYLON.Color3(0.3, 0.45, 0.2);
    ground.material = groundMat;
    ground.receiveShadows = true;
    ground.physicsImpostor = new BABYLON.PhysicsImpostor(ground, BABYLON.PhysicsImpostor.BoxImpostor, { mass: 0, restitution: 0.1, friction: 1 }, scene);
    
    // 4. اللاعب (كرة فيزيائية غير مرئية)
    var playerSphere = BABYLON.MeshBuilder.CreateSphere("playerSphere", {diameter: 2, segments: 32}, scene);
    playerSphere.position = new BABYLON.Vector3(0, 6, 0);
    playerSphere.visibility = 0;
    playerSphere.physicsImpostor = new BABYLON.PhysicsImpostor(playerSphere, BABYLON.PhysicsImpostor.SphereImpostor, { mass: 2, restitution: 0.0, friction: 0.5 }, scene);

    // 5. تحميل الشخصية 3D الحقيقية (الروبوت)
    var playerModel; 
    
    BABYLON.SceneLoader.ImportMesh(
        "", 
        "https://raw.githubusercontent.com/BabylonJS/Assets/master/meshes/Dude/Dude.glb", 
        "", 
        scene, 
        function (newMeshes) {
            playerModel = newMeshes[0]; 
            playerModel.scaling.scaleInPlace(0.3); 
            playerModel.position.y = 0; 
            shadowGen.addShadowCaster(playerModel); 
            playerModel.parent = playerSphere;
        }
    );

    // 6. كاميرا التتبع
    var camera = new BABYLON.FollowCamera("followCam", new BABYLON.Vector3(0, 10, -20), scene);
    camera.lockedTarget = playerSphere; 
    camera.radius = 12;            
    camera.heightOffset = 6;       
    camera.rotationOffset = 0;     
    camera.cameraAcceleration = 0.1;
    camera.maxCameraSpeed = 20;
    camera.attachControl(canvas, true);

    // 7. عصا التحكم باللمس وواجهة المستخدم
    var advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");
    var scoreText = new BABYLON.GUI.TextBlock();
    scoreText.text = "Score: 0";
    scoreText.color = "white";
    scoreText.fontSize = 24;
    scoreText.top = "10px";
    scoreText.left = "10px";
    scoreText.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
    scoreText.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
    advancedTexture.addControl(scoreText);

    var leftJoystick = new BABYLON.VirtualJoystick(true); 
    leftJoystick.setJoystickSensibility(0.15); 

    // 8. تحكم وحركة (يتم تنفيذه في حلقة العرض)
    var moveForce = 12; 
    var jumpForce = 6;  
    var canJump = false;
    var lastJumpTime = 0;

    scene.onBeforeRenderObservable.add(function () {
        var dt = engine.getDeltaTime() / 1000;
        var joyX = leftJoystick.deltaPosition.x / 100;
        var joyY = leftJoystick.deltaPosition.y / 100;

        var moveVector = new BABYLON.Vector3(joyX, 0, joyY);
        
        if (moveVector.length() > 0.001) {
            // كود تحويل الاتجاه حسب الكاميرا وتطبيق القوة (Impulse)
            var camForward = camera.getForwardRay().direction;
            var camRight = BABYLON.Vector3.Cross(camForward, BABYLON.Vector3.Up()).normalize();
            var forward = new BABYLON.Vector3(camForward.x, 0, camForward.z).normalize();
            var right = new BABYLON.Vector3(camRight.x, 0, camRight.z).normalize();

            var dir = forward.scale(moveVector.z).add(right.scale(moveVector.x));
            if (dir.length() > 0.001) {
                dir = dir.normalize().scale(moveForce);
                playerSphere.physicsImpostor.applyImpulse(dir.scale(dt), playerSphere.getAbsolutePosition());
            }
        }
        
        // دوران النموذج
        if (playerModel && moveVector.length() > 0.001) {
            var targetRotation = Math.atan2(dir.x, dir.z);
            playerModel.rotation.y = targetRotation;
        }

        // قفز
        var now = Date.now();
        if ((Math.abs(joyY) > 0.6) && canJump && (now - lastJumpTime) > 350) { 
            var up = new BABYLON.Vector3(0, jumpForce, 0);
            playerSphere.physicsImpostor.applyImpulse(up, playerSphere.getAbsolutePosition());
            lastJumpTime = now;
        }
    });

    // كود فحص القفز
    scene.registerAfterRender(function () {
        var pos = playerSphere.position;
        var ray = new BABYLON.Ray(pos, new BABYLON.Vector3(0, -1, 0), 1.1);
        var pick = scene.pickWithRay(ray, function(mesh) { return mesh === ground; });
        canJump = (pick && pick.hit);
    });

    return scene;
};

// === (2) تشغيل الحلقة الرئيسية للمحرك ===
// هذا الجزء ضروري جداً لتشغيل اللعبة في النمط التقليدي
var scene = createScene();

engine.runRenderLoop(function () {
    if (scene) scene.render();
});

window.addEventListener("resize", function () {
    engine.resize();
});
